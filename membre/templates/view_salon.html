{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ salon.nom }}</title>
    <style>
        #messages-container {
            max-height: 400px; /* Ajustez selon vos besoins */
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }

        ul#messages {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        li {
            margin-bottom: 10px;
        }
    </style>

    <!-- Charger le CSS d'Emoji Mart -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-mart@5.6.0/css/emoji-mart.css">

    <script type="module">
        import { Picker } from 'https://cdn.jsdelivr.net/npm/emoji-mart@5.6.0/+esm';

        document.addEventListener('DOMContentLoaded', async () => {
            // Charger les donnÃ©es d'emoji
            const response = await fetch('https://cdn.jsdelivr.net/npm/@emoji-mart/data');
            const data = await response.json();

            // Initialiser WebSocket
            const salonId = "{{ salon.id }}";
            const socket = new WebSocket(`ws://${window.location.host}/ws/salon/${salonId}/`);
            const messagesContainer = document.getElementById('messages-container');
            const messagesList = document.getElementById('messages');

            // Fonction pour faire dÃ©filer automatiquement vers le bas
            const scrollToBottom = () => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            // Ã‰vÃ©nement pour recevoir les messages
            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const newMessage = document.createElement('li');
                newMessage.innerHTML = `<strong>${data.user}</strong>: ${data.message}`;
                messagesList.appendChild(newMessage);

                // Scroller automatiquement vers le bas
                scrollToBottom();
            };

            socket.onopen = () => console.log("WebSocket connectÃ© !");
            socket.onerror = error => console.error("Erreur WebSocket :", error);
            socket.onclose = () => console.warn("WebSocket fermÃ© !");

            // Gestion de l'envoi des messages
            const form = document.querySelector('form');
            form.onsubmit = function (e) {
                e.preventDefault();
                const input = document.getElementById('contenu');
                const message = input.value;

                // Envoyer le message via WebSocket
                socket.send(JSON.stringify({ 'message': message }));

                input.value = ''; // Vider le champ aprÃ¨s envoi
            };

            // Scroll initial vers le bas (au chargement des messages existants)
            scrollToBottom();

            // Ajouter des boutons pour emojis textuels
            const emojiButtons = document.querySelectorAll('.emoji-button');
            emojiButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const emoji = button.getAttribute('data-emoji');
                    const input = document.getElementById('contenu');
                    const cursorPos = input.selectionStart;
                    const textBefore = input.value.substring(0, cursorPos);
                    const textAfter = input.value.substring(cursorPos);
                    input.value = textBefore + emoji + textAfter;
                    input.focus();
                    input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
                });
            });
        });
    </script>
</head>
<body>
    <h1>{{ salon.nom }}</h1>
    <p>{{ salon.description }}</p>
    {% if salon.created_by == request.user %}
    <a href="{% url 'edit_salon' salon.id %}">
        <button>Modifier le salon</button>
    </a>
    {% endif %}

    <a href="{% url 'salon_disponible' %}">
        <button>Retour Ã  la liste des salons</button>
    </a>

    <h2>Messages</h2>
    <div id="messages-container">
        <ul id="messages">
            {% for message in salon.messages.all %}
                <li><strong>{{ message.user.username }}</strong>: {{ message.contenu }}</li>
            {% endfor %}
        </ul>
    </div>

    <form>
        <textarea id="contenu" name="contenu" rows="4" placeholder="Ã‰crivez un message..."></textarea>
        
        <!-- Boutons emoji textuels -->
        <button type="button" class="emoji-button" data-emoji="ðŸ˜Š">ðŸ˜Š</button>
        <button type="button" class="emoji-button" data-emoji="ðŸ˜‚">ðŸ˜‚</button>
        <button type="button" class="emoji-button" data-emoji="ðŸ˜œ">ðŸ˜œ</button>
        <button type="button" class="emoji-button" data-emoji="ðŸ˜„">ðŸ˜„</button>
        <button type="button" class="emoji-button" data-emoji="ðŸ˜º">ðŸ˜º</button>
        <button type="button" class="emoji-button" data-emoji="ðŸ˜‰">ðŸ˜‰</button>

        <button type="submit">Envoyer</button>
    </form>
</body>
</html>
